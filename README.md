# FaceCrop - Автоматический кроп фотографий до квадрата

Приложение для автоматического кропа фотографий до квадратного формата с сохранением лица человека в центре кадра.

## Возможности

- ✅ Автоматическая детекция лица на фотографии
- ✅ Умный расчет квадратного кропа с учетом положения лица
- ✅ Поддержка различных форматов (JPG, PNG, WEBP)
- ✅ Batch обработка файлов и папок
- ✅ CLI и Web UI интерфейсы
- ✅ Настройка параметров кропа (размер, множитель, padding)
- ✅ Визуализация процесса (режим отладки)

## Установка

### Требования

- Python 3.8 или выше
- pip

### Установка зависимостей

```bash
pip install -r requirements.txt
```

Или установите пакет:

```bash
pip install -e .
```

## Быстрый старт

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Обработайте одно изображение:
```bash
python -m facecrop --input photo.jpg --output output/
```

3. Или запустите Web UI:
```bash
python -m facecrop --ui
```

## Использование

### CLI интерфейс

#### Базовое использование

```bash
# Обработать один файл
python -m facecrop --input photo.jpg --output output/

# Обработать папку
python -m facecrop --input photos/ --output output/

# Рекурсивная обработка
python -m facecrop --input photos/ --output output/ --recursive
```

#### Параметры

- `--input, -i` - Входной файл или папка (обязательно)
- `--output, -o` - Выходная папка (обязательно)
- `--size` - Размер квадрата в пикселях (по умолчанию 1024)
- `--k` - Множитель размера лица для квадрата (по умолчанию 2.5)
  - Меньшие значения (1.5-2.0) - лицо крупнее в кадре
  - Большие значения (3.0-4.0) - больше контекста вокруг лица
- `--padding` - Тип padding если изображение меньше квадрата:
  - `none` - без padding (по умолчанию)
  - `blur` - размытие фона
  - `mirror` - зеркальное отражение краев
  - `solid` - однотонный цвет (средний цвет изображения)
- `--recursive, -r` - Рекурсивная обработка подпапок
- `--dry-run` - Только расчет без сохранения файлов
- `--visualize, -v` - Сохранить визуализацию с рамками лица и кропа

#### Примеры

```bash
# Квадраты 512x512 с большим контекстом
python -m facecrop -i photos/ -o output/ --size 512 --k 3.0

# С размытым padding
python -m facecrop -i photos/ -o output/ --padding blur

# С визуализацией для отладки
python -m facecrop -i photos/ -o output/ --visualize

# Проверка без сохранения
python -m facecrop -i photos/ -o output/ --dry-run
```

### Web UI

Запустите веб-интерфейс одним из способов:

```bash
# Способ 1: Через CLI с флагом --ui (рекомендуется)
python -m facecrop --ui

# Способ 2: Простой запуск через run_ui.py
python run_ui.py

# Способ 3: Напрямую через модуль
python -m facecrop.ui

# Способ 4: С указанием порта (если 7860 занят)
python -m facecrop --ui --port 7861
```

После запуска в терминале появится сообщение с адресом. Откройте браузер по указанному адресу (обычно `http://127.0.0.1:7860`).

**Важно:** Сервер должен оставаться запущенным. Не закрывайте окно терминала пока используете Web UI.

В Web UI вы можете:
- Загрузить несколько изображений
- Настроить параметры кропа
- Предпросмотреть результаты
- Скачать все результаты одним ZIP-архивом

## Алгоритм работы

1. **Детекция лица**: Используется MediaPipe Face Detection для поиска лица на изображении
   - Модель автоматически скачивается при первом использовании
   - Поддерживает детекцию лиц на разном расстоянии

2. **Расчет квадратного кропа**:
   - Определяется центр лица
   - Вычисляется размер квадрата: `side = max(face_width, face_height) * k * (1 + safety_margin)`
   - Квадрат центрируется по лицу
   - Если квадрат выходит за границы - смещается внутрь
   - Если изображение меньше квадрата - уменьшается размер или добавляется padding

3. **Обработка**:
   - Учитывается EXIF ориентация
   - Применяется кроп
   - При необходимости добавляется padding
   - Ресайз до целевого размера

4. **Fallback**: Если лицо не найдено - центральный кроп до квадрата

## Структура проекта

```
.
├── src/
│   └── facecrop/
│       ├── __init__.py
│       ├── core.py          # Core функции детекции и кропа
│       ├── main.py          # CLI интерфейс
│       ├── ui.py            # Web UI
│       └── __main__.py      # Точка входа
├── tests/
│   └── test_core.py         # Unit тесты
├── requirements.txt
├── setup.py
└── README.md
```

## Тестирование

Запустите тесты:

```bash
python -m pytest tests/
```

Или:

```bash
python -m unittest discover tests
```

## Технические детали

### Детекция лица

Используется **MediaPipe Face Detection**:
- Модель: `mediapipe.solutions.face_detection`
- Автоматически скачивается при первом импорте
- Поддерживает детекцию лиц на разном расстоянии (model_selection=1 для дальних лиц)
- Минимальная уверенность: 0.5

### Обработка изображений

- **Pillow (PIL)** для основной работы с изображениями
- **OpenCV** для конвертации цветовых пространств и размытия
- Поддержка форматов: JPG, PNG, WEBP
- Сохранение EXIF данных

### Параметры по умолчанию

- Размер квадрата: 1024x1024
- Множитель k: 2.5 (лицо занимает ~40% кадра)
- Safety margin: 15% (гарантирует полное лицо)
- Качество JPEG: 95%

## Устранение неполадок

### Лицо не обнаруживается

- Убедитесь, что на фото четко видно лицо
- Попробуйте уменьшить параметр `--k` (больше контекста может помочь)
- Используйте `--visualize` для проверки детекции

### Плохое качество кропа

- Настройте параметр `--k`:
  - Уменьшите для более крупного лица
  - Увеличьте для большего контекста
- Используйте `--visualize` для анализа

### Ошибки установки

- Убедитесь, что Python версии 3.8+
- Для MediaPipe может потребоваться обновление pip: `pip install --upgrade pip`
- На некоторых системах может потребоваться установка дополнительных зависимостей

## Лицензия

MIT License

## Автор

FaceCrop Project

#   p h o t o c r o p  
 